---
title: Add or Change Test Factories & Support
created_at: 2020/01/13
excerpt: TODO
---

# Add or Change Test Factories & Support

Procedures for using the `/support` and `/factories` extension points.


## Configure a Factory

Each factory method uses a configurable set of default values to generate a model instance when no custom values are provided. Default values are either a Hash or a Proc instance that returns a hash consisting of values that are determined at the time the method is called. A Proc is executed within the context of the Workarea::Factories module, allowing access to other factory methods to generate default values like associations or ensure a unique name is generated for each model instance generated by the factory method.

```
Workarea.configure do |config|
  config.testing_factory_defaults.inventory =
    { id: 'SKU', policy: 'standard', available: 5 }

  config.testing_factory_defaults.audit_log_entry = Proc.new do
    { modifier: create_user, audited: create_page }
  end

  config.testing_factory_defaults.shipping_service = Proc.new do
    { name: "Test #{shipping_service_count}", rates: [{ price: 1.to_m }] }
  end
end
```

These default values can be customized for your application to modify the default model instances across the entire test suite without having to decorate each individual test. A common use case would be adding a default value for a field that your application requires but is not required out of the base Workarea model (e.g. phone number on shipping address).

You can customize these values in your application's test_helper.rb

```
# Modify the configuration for factory default values
# test/test_helper.rb

ENV['RAILS_ENV'] ||= 'test'
require File.expand_path('../../config/environment', __FILE__ )
require 'rails/test_help'
require 'workarea/test_help'

Workarea.configure do |config|
  config.testing_factory_defaults.shipping_address[:phone_number] = '2155551212'
end
```

Additionally, you can customize the factory default values for the duration of a single test.

Since Workarea 3.5.0, the global configuration is reset before each test. Prior to Workarea 3.5.0, you must wrap temporary configuration changes in Workarea.with_config to ensure they reset after the test.

Example for Workarea 3.5 and up:

```
# test/system/storefront/categories_system_test.decorator

require 'test_helper'

module Workarea
  decorate Storefront::CategoriesSystemTest do

    # Decorate setup method
    def set_products
      config.testing_factory_defaults.product.merge!(
        # add customized defaults
      )

      super
    end
  end
end
```

Example for Workarea versions prior to 3.5:

```
# test/system/storefront/categories_system_test.decorator

require 'test_helper'

module Workarea
  decorate Storefront::CategoriesSystemTest do

    # Decorate setup method
    def set_products
      Workarea.with_config do |config|
        config.testing_factory_defaults.product.merge!(
          # add customized defaults
        )

        super
      end
    end
  end
end
```

## Add a Factory

As you develop your application, you may have the need to extend the various test help modules described above, or add your own. The steps to to this are as follows.

    Create new modules
    Require them in your application test helper
    Mix them into your test cases as needed

Plugins create these modules under test/support/ , or test/factories/ in the case of factories, since files at these paths are required automatically by the host application. Applications should follow these conventions, but files at these paths within the application are not required automatically, so you must require each module in your test helper.

In addition to creating your own modules, re-open existing modules as needed to extend them. The following examples show two new files: one file to add a new factory module , and another to re-open an existing test helper. Both files are required in the application's test helper.

```
# Add factory methods to use within tests of your custom functionality
# test/factories/entertainment.rb

module Workarea
  module Factories
    module Entertainment

      # Register your factory to include it with the other factories
      Factories.add(self)

      # Add as many factory methods as you need
      def create_calendar(overrides = {})
        attributes = { name: 'Test Calendar' }.merge(overrides)
        Workarea::Entertainment::Calendar.create!(attributes)
      end

      # ...
    end
  end
end
```

```
# Add a test help file which re-opens an existing test helper
# test/support/storefront_system_test_extensions.rb

# Re-open the module
module Workarea
  module Storefront
    module SystemTest

      # Redefine or extend the module's instance methods as needed
      def fill_in_email
        fill_in 'email', match: :first, with: 'bcrouse-new-account@workarea.com'
      end
    end
  end
end
```

```
# Require your new modules in your test helper
# test/test_helper.rb

ENV['RAILS_ENV'] ||= 'test'
require File.expand_path('../../config/environment', __FILE__ )
require 'rails/test_help'
require 'workarea/test_help'
```

```
# Require additional test help
require 'factories/entertainment'
require 'support/storefront_system_test_extensions'
```

You can also extend the various test help methods for the duration of a single test case by decorating the test case (or defining your own test case) and extending the relevant instance methods there. The example below shows a test decorator extending a factory method.

```
# test/workers/workarea/bulk_index_products_test.decorator

require 'test_helper'

module Workarea
  decorate BulkIndexProductsTest do

    # Decorate a factory method
    def create_product
      # ...
    end

    # Decorate a test
    def test_perform
      # Use the redefined create_product method within the test
    end
  end
end
```

## Change a Test Case Mixin


## Add a Test Case Mixin


## Change a Test Case Type


## Add a Test Case Type
